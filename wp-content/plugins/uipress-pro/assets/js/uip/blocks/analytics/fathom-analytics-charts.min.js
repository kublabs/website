const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as connectFathom from"./fathom-connect-account.min.js";export function moduleData(){return{components:{"uip-connect-fathom":connectFathom.moduleData()},props:{display:String,name:String,block:Object,contextualData:Object},data:function(){return{loading:!0,rendered:!0,error:!1,apiLoaded:!1,errorMessage:"",total:0,comparisonTotal:0,percentChange:0,fetchingQuery:!1,showFathomConnection:!1,requestFromGroupDate:!1,currentRequest:!1,chartData:{data:{main:[],comparison:[]},labels:{main:[],comparison:[]},title:"",colors:{main:this.returnLineColor,comp:this.returnCompLineColor}},strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro")}}},inject:["uipData","uipress","uiTemplate"],watch:{"block.settings.block.options.chartDataType":{handler(t,e){this.currentRequest&&this.processResponse()}},"contextualData.groupDate":{handler(t,e){this.getAnalytics()},deep:!0},"uiTemplate.fathomAnalytics.ready":{handler(t,e){this.getAnalytics()},deep:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(t,e){this.refreshAnalytics()}},returnRange:{handler(t,e){this.getAnalytics()}}},mounted:function(){this.getAnalytics()},computed:{returnChartSettings(){return this.uipress.get_block_option(this.block,"block","chartOptions")},returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let t=this.uipress.get_block_option(this.block,"block","chartName",!0);return t?this.uipress.isObject(t)?"string"in t?t.string:void 0:t:""},returnChartType(){return this.uipress.get_block_option(this.block,"block","chartDataType")},returnChartStyle(){let t=this.uipress.get_block_option(this.block,"block","chartStyle");return"value"in t&&""!=t.value?t.value:"line"},returnLineColor(){let t=this.uipress.get_block_option(this.block,"block","chartColour");return this.uipress.isObject(t)&&"value"in t&&""!=t.value?t.value:t},returnCompLineColor(){let t=this.uipress.get_block_option(this.block,"block","chartCompColour");return this.uipress.isObject(t)&&"value"in t&&""!=t.value?t.value:t},hideChart(){let t=this.uipress.get_block_option(this.block,"block","hideChart");return this.uipress.isObject(t)?"value"in t&&""!=t.value&&t.value:t},chartDimensions(){let t=this;this.rendered=!1;let e=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","width","value"]),a=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","width","units"]),i=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","height","value"]),n=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","height","units"]);if(requestAnimationFrame(function(){t.rendered=!0}),e||i)return`width:${e}${a};height:${i}${n};`},inlineAccountSwitch(){let t=this.uipress.get_block_option(this.block,"block","inlineAccountSwitch");return this.uipress.isObject(t)?"value"in t&&""!=t.value&&t.value:t},returnRange(){let t=this.uipress.get_block_option(this.block,"block","dateRange");return t?isNaN(t)?14:t>60?60:t:14},hasGlobalDate(){return void 0!==this.contextualData&&(!!this.uipress.isObject(this.contextualData)&&("groupDate"in this.contextualData&&("start"in this.contextualData.groupDate&&"end"in this.contextualData.groupDate)))}},methods:{getAnalytics(){let t,e,a=this;a.loading=!0,a.error=!1,a.errorMessage="",a.showFathomConnection=!1,a.uipress.isObject(a.uiTemplate.fathomAnalytics)&&"ready"in a.uiTemplate.fathomAnalytics&&a.uiTemplate.fathomAnalytics.ready?(a.apiLoaded=!0,this.hasGlobalDate?(t=new Date(Date.parse(this.contextualData.groupDate.start)),e=new Date(Date.parse(this.contextualData.groupDate.end))):((e=new Date).setDate(e.getDate()-1),(t=new Date).setDate(t.getDate()-a.returnRange)),a.uiTemplate.fathomAnalytics.api("get",t,e).then(t=>{if(t.error)return a.loading=!1,a.error=!0,a.errorMessage=t.message,void("no_account"==t.type&&(a.showFathomConnection=!0));a.loading=!1,a.currentRequest=t,a.processResponse(t)})):a.apiLoaded=!1},processResponse(){let t=this,e=this.currentRequest,a=[],i=[],n=t.returnChartType,s=[],r=[],o=0,l=0,u=0,c=0;console.log(e);for(let t of e.dates){let i=new Date(t).toLocaleDateString();a.push(i);let r=e.timeline_reports.find(e=>e.date===t);r?(s.push(r[n]),o+=parseInt(r[n]),u+=1):s.push("0")}for(let t of e.comparison_dates){let a=new Date(t).toLocaleDateString();i.push(a);let s=e.timeline_reports_comparison.find(e=>e.date===t);s?(r.push(s[n]),l+=parseInt(s[n]),c+=1):r.push("0")}t.returnChartSettings&&(t.chartData.custom=t.returnChartSettings),"bounce_rate"==n&&(0!==o&&u>0&&(o=(o/u*100).toFixed(2)),0!==l&&c>0&&(l=(l/c*100).toFixed(2))),"avg_duration"==n&&(0!==o&&u>0&&(o=(o/u).toFixed(2),t.total=new Date(1e3*o).toISOString().substring(14,19)),0!==l&&c>0&&(l=(l/c).toFixed(2),t.comparisonTotal=new Date(1e3*l).toISOString().substring(14,19))),t.chartData.colors.main=t.returnLineColor,t.chartData.colors.comp=t.returnCompLineColor,t.chartData.title=t.returnName,t.chartData.type=t.returnChartStyle,t.chartData.data.main=s,t.chartData.data.comparison=r,t.chartData.labels.main=a,t.chartData.labels.comparison=i,"avg_duration"!=n&&(t.total=new Intl.NumberFormat(t.uipress.uipAppData.options.locale).format(o),t.comparisonTotal=new Intl.NumberFormat(t.uipress.uipAppData.options.locale).format(l)),"bounce_rate"==n&&(t.total=t.total+"%",t.comparisonTotal=t.comparisonTotal+"%"),t.percentChange=0==o||0==l?(100*o).toFixed(0):(o/l*100).toFixed(0)},removeAnalyticsAccount(){let t=this;t.uiTemplate.fathomAnalytics.ready=!1,t.uiTemplate.fathomAnalytics.api("removeAccount").then(e=>{t.uiTemplate.fathomAnalytics.api("refresh").then(e=>{t.uiTemplate.fathomAnalytics.ready=!0,t.getAnalytics()})})},secondsToTime(t){if(isNaN(t))return 0;Math.floor(t/3600).toString().padStart(2,"0");const e=Math.floor(t%3600/60).toString().padStart(2,"0"),a=Math.floor(t%60).toString().padStart(2,"0");return 0==e?"0m "+a+"s":e+"m "+a+"s"},refreshAnalytics(){let t=this;t.uiTemplate.fathomAnalytics.ready=!1,t.uiTemplate.fathomAnalytics.api("refresh").then(e=>{e&&(t.uiTemplate.fathomAnalytics.ready=!0,t.getAnalytics())})},returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(t){return this.errorMessage}if(this.uipress.isObject(JSON.parse(this.errorMessage))){let t=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${t.status}</h5>\n              <p style="margin-bottom:0;">${t.message}</p>\n            `}return this.errorMessage}},template:'\n\t<div class="uip-flex uip-flex-column uip-text-normal">\n  \n        <div class="uip-flex uip-flex-between">\n          <div class="uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n          \n          <drop-down dropPos="left" v-if="!inlineAccountSwitch && !showFathomConnection">\n            <template v-slot:trigger>\n              <div class="uip-icon uip-link-muted uip-text-l">more_horiz</div>\n            </template>\n            <template v-slot:content>\n              <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-center uip-padding-xxxs uip-link-muted" @click="removeAnalyticsAccount()">\n                <div class="uip-icon">sync</div>                <div class="uip-padding-xxs">{{strings.changeAccount}}</div>\n              </div>\n            </template>\n          </drop-down>  \n        </div>\n        \n        <div class="uip-margin-bottom-xxs"><uip-connect-fathom v-if="showFathomConnection" :success="refreshAnalytics"></uip-connect-fathom></div>\n        \n        <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle uip-min-w-200 uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n        \n        <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n        \n        <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n        \n        <div v-else class="uip-min-w-200">\n          <div class="uip-flex uip-flex-column uip-row-gap-xs">\n            <div class="uip-flex uip-flex-between uip-gap-xxs uip-flex-center">\n              <div class="uip-text-xl uip-text-bold">{{returnTotal}}</div>\n              <div class="uip-text-s uip-background-orange-wash uip-border-round uip-padding-xxxs uip-padding-left-xs uip-padding-right-xs uip-post-type-label uip-flex uip-gap-xxs uip-flex-center uip-text-bold uip-tag-label">\n                <span v-if="percentChange > 0" class="uip-icon">arrow_upward</span>\n                <span v-if="percentChange < 0" class="uip-icon">arrow_downward</span>\n                <span>{{percentChange}}%</span>\n              </div>\n            </div>\n            <div class="uip-text-muted uip-margin-bottom-xs">vs. {{returnComparisonTotal}} {{strings.lastPeriod}}</div>\n            <uip-chart v-if="!hideChart && rendered" :chartData="returnChartData" :style="chartDimensions"></uip-chart>\n            <div class="uip-flex uip-flex-row uip-flex-between" v-if="!hideChart">\n              <div class="uip-text-s uip-text-muted uip-chart-label">{{chartData.labels.main[0]}}</div>\n              <div class="uip-text-s uip-text-muted uip-chart-label">{{chartData.labels.main[chartData.labels.main.length - 1]}}</div>\n            </div>\n          </div>\n        </div>\n\t\t </div>'}};