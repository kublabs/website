const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as connectMatomo from"./matomo-connect-account.min.js";export function moduleData(){return{components:{"uip-connect-matomo":connectMatomo.moduleData()},props:{display:String,name:String,block:Object,contextualData:Object},data:function(){return{loading:!0,rendered:!0,error:!1,apiLoaded:!1,errorMessage:"",total:0,comparisonTotal:0,percentChange:0,fetchingQuery:!1,showMatomoConnection:!1,requestFromGroupDate:!1,currentRequest:!1,matomoPath:"",currentData:[],strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro"),count:__("Count","uipress-pro"),change:__("Change","uipress-pro")}}},inject:["uipData","uipress","uiTemplate"],watch:{"block.settings.block.options.chartDataType":{handler(t,e){if(this.currentRequest){let t=this;this.loading=!0,this.processResponse(),requestAnimationFrame(function(){t.loading=!1})}}},"contextualData.groupDate":{handler(t,e){this.getAnalytics()},deep:!0},"uiTemplate.matomoAnalytics.ready":{handler(t,e){this.getAnalytics()},deep:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(t,e){this.refreshAnalytics()}}},mounted:function(){this.getAnalytics()},computed:{returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let t=this.uipress.get_block_option(this.block,"block","chartName",!0);return t?this.uipress.isObject(t)?"string"in t?t.string:void 0:t:""},returnChartType(){return this.uipress.get_block_option(this.block,"block","chartDataType")},returnChartStyle(){let t=this.uipress.get_block_option(this.block,"block","chartStyle");return"value"in t&&""!=t.value?t.value:"line"},returnLineColor(){let t=this.uipress.get_block_option(this.block,"block","chartColour");return this.uipress.isObject(t)&&"value"in t&&""!=t.value?t.value:t},returnCompLineColor(){let t=this.uipress.get_block_option(this.block,"block","chartCompColour");return this.uipress.isObject(t)&&"value"in t&&""!=t.value?t.value:t},hideChart(){let t=this.uipress.get_block_option(this.block,"block","hideChart");return this.uipress.isObject(t)?"value"in t&&""!=t.value&&t.value:t},chartDimensions(){let t=this;this.rendered=!1;let e=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","width","value"]),i=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","width","units"]),a=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","height","value"]),s=this.uipress.checkNestedValue(this.block,["settings","chartCanvas","options","dimensions","value","height","units"]);if(requestAnimationFrame(function(){t.rendered=!0}),e||a)return`width:${e}${i};height:${a}${s};`},inlineAccountSwitch(){let t=this.uipress.get_block_option(this.block,"block","inlineAccountSwitch");return this.uipress.isObject(t)?"value"in t&&""!=t.value&&t.value:t},returnRange(){let t=this.uipress.get_block_option(this.block,"block","dateRange");return t?isNaN(t)?14:t>60?60:t:14},hasGlobalDate(){return void 0!==this.contextualData&&(!!this.uipress.isObject(this.contextualData)&&("groupDate"in this.contextualData&&("start"in this.contextualData.groupDate&&"end"in this.contextualData.groupDate)))}},methods:{getAnalytics(){let t,e,i=this;i.loading=!0,i.error=!1,i.errorMessage="",i.showMatomoConnection=!1,i.uipress.isObject(i.uiTemplate.matomoAnalytics)&&"ready"in i.uiTemplate.matomoAnalytics&&i.uiTemplate.matomoAnalytics.ready?(i.apiLoaded=!0,this.hasGlobalDate?(t=new Date(Date.parse(this.contextualData.groupDate.start)),e=new Date(Date.parse(this.contextualData.groupDate.end))):((e=new Date).setDate(e.getDate()-1),(t=new Date).setDate(t.getDate()-i.returnRange)),i.uiTemplate.matomoAnalytics.api("get",t,e).then(t=>{if(t.error)return i.loading=!1,i.error=!0,i.errorMessage=t.message,void("no_account"==t.type&&(i.showMatomoConnection=!0));i.loading=!1,i.currentRequest=t,i.matomoPath=t.matomoPath,i.matomoPath.endsWith("/")||(i.matomoPath=i.matomoPath+"/"),i.processResponse(t)})):i.apiLoaded=!1},processResponse(){let t=this.currentRequest,e=this.returnChartType;if(!e)return;let i=[];for(let[a,s]of t.reports[e].entries()){s.change=100*s.nb_visits;let n=t.reports_comparison[e][a];if(n){let t=n.nb_visits,e=s.nb_visits;0!=t&&0!=e&&(s.change=(e/t*100).toFixed(2))}i.push(s)}this.currentData=i},removeAnalyticsAccount(){let t=this;t.uiTemplate.matomoAnalytics.ready=!1,t.uiTemplate.matomoAnalytics.api("removeAccount").then(e=>{t.uiTemplate.matomoAnalytics.api("refresh").then(e=>{t.uiTemplate.matomoAnalytics.ready=!0,t.getAnalytics()})})},secondsToTime(t){if(isNaN(t))return 0;Math.floor(t/3600).toString().padStart(2,"0");const e=Math.floor(t%3600/60).toString().padStart(2,"0"),i=Math.floor(t%60).toString().padStart(2,"0");return 0==e?"0m "+i+"s":e+"m "+i+"s"},refreshAnalytics(){let t=this;t.uiTemplate.matomoAnalytics.ready=!1,t.uiTemplate.matomoAnalytics.api("refresh").then(e=>{e&&(t.uiTemplate.matomoAnalytics.ready=!0,t.getAnalytics())})},returnFormattedDate(t){if(!t||""==t)return"";let e=t.getMonth()+1,i=t.getDate(),a=t.getFullYear();return e<10&&(e="0"+e),i<10&&(i="0"+i),a+"/"+e+"/"+i},returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(t){return this.errorMessage}if(this.uipress.isObject(JSON.parse(this.errorMessage))){let t=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${t.status}</h5>\n              <p style="margin-bottom:0;">${t.message}</p>\n            `}return this.errorMessage},returnStartDate(){let t=Object.keys(this.currentRequest.reports.page_views)[0];return(t=new Date(t)).toLocaleDateString()},returnEndDate(){let t=Object.keys(this.currentRequest.reports.page_views).length-1,e=Object.keys(this.currentRequest.reports.page_views)[t];return(e=new Date(e)).toLocaleDateString()}},template:'\n\t\t<div class="uip-flex uip-flex-column uip-text-normal">\n          <div class="uip-flex uip-flex-between">\n            <div class="uip-text-bold uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n            <drop-down dropPos="left" v-if="!inlineAccountSwitch && !showGoogleConnection">\n              <template v-slot:trigger>\n                <div class="uip-icon uip-link-muted">more_horiz</div>\n              </template>\n              <template v-slot:content>\n                <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-center uip-padding-xxxs uip-link-muted" @click="removeAnalyticsAccount()">\n                  <div class="uip-icon">sync</div>                  <div class="uip-padding-xxs">{{strings.changeAccount}}</div>\n                </div>\n              </template>\n            </drop-down>  \n          </div>\n          \n          <div class="uip-text-s uip-text-muted uip-margin-bottom-s uip-margin-bottom-s uip-dates">{{returnFormattedDate(startDate)}} - {{returnFormattedDate(endDate)}}</div>\n          \n          <div class="uip-margin-bottom-xxs" v-if="showGoogleConnection"><uip-connect-google :success="refreshAnalytics"></uip-connect-google></div>\n          \n          <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle uip-min-w-200 uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n          \n          <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n          \n          <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n          \n          <div v-else class="uip-min-w-200">\n            <div class="uip-flex uip-flex-column uip-row-gap-xs">\n              <div class="uip-max-w-100p uip-overflow-auto uip-scrollbar">\n                <table class="uip-min-w-250 uip-w-100p uip-table">\n                  <thead>\n                    <tr class="">\n                      <th class="uip-padding-bottom-xxs"></th>\n                      <th class="uip-text-muted uip-text-weight-normal uip-text-right uip-padding-bottom-xxs">{{strings.count}}</th>\n                      <th class="uip-text-right uip-text-muted uip-text-weight-normal uip-padding-bottom-xxs">{{strings.change}}</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    <tr v-for="item in currentData">\n                      <td class="uip-text-bold uip-padding-bottom-xxs uip-flex uip-gap-xs uip-flex-center">\n                        <img v-if="item.logo" :src="matomoPath + item.logo" class="uip-h-12 uip-border-rounder">\n                        <span>{{item.label}}</span>\n                      </td>\n                      <td class="uip-text-right uip-padding-bottom-xxs">{{item.nb_visits}}</td>\n                      <td class="uip-text-right uip-padding-bottom-xxs">\n                        <div class="uip-text-s uip-background-orange-wash uip-border-round uip-padding-xxxs uip-post-type-label uip-flex uip-gap-xxs uip-flex-center uip-text-bold uip-tag-label uip-inline-flex">\n                          <span v-if="item.change > 0" class="uip-icon uip-text-green">arrow_upward</span>\n                          <span v-if="item.change < 0" class="uip-icon uip-text-danger">arrow_downward</span>\n                          <span class="uip-percentage-value">{{item.change}}</span>\n                        </div>\n                      </td>\n                    </tr>\n                  </tbody>\n                </table>\n              </div>\n              <div class="uip-flex uip-flex-row uip-flex-between">\n                <div class="uip-text-s uip-text-muted uip-chart-label">{{returnStartDate()}}</div>\n                <div class="uip-text-s uip-text-muted uip-chart-label">{{returnEndDate()}}</div>\n              </div>\n            </div>\n          </div>\n      </div>'}};