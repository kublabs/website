const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as connectGoogle from"./google-connect-account.min.js";import*as mapbox from"../../../libs/mapbox.js";import*as countries from"../../../libs/country_data.min.js";mapboxgl.accessToken="pk.eyJ1IjoibWFya2FzaHRvbiIsImEiOiJjbGRrZGYyc2IwamRuM3ZsZ2JudXdwMjRtIn0.V_oXBXMGBUBty-fZY0VXfg";export function moduleData(){return{components:{"uip-connect-google":connectGoogle.moduleData()},props:{display:String,name:String,block:Object,contextualData:Object},data:function(){return{loading:!0,error:!1,map:!1,apiLoaded:!1,errorMessage:"",total:0,comparisonTotal:0,percentChange:0,fetchingQuery:!1,showGoogleConnection:!1,requestFromGroupDate:!1,currentRequest:!1,startDate:"",endDate:"",currentData:[],chartData:{data:{main:[],comparison:[]},labels:{main:[],comparisons:[]},title:"",colors:{main:this.returnLineColor,comp:this.returnCompLineColor}},strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro"),count:__("Count","uipress-pro"),change:__("Change","uipress-pro"),current:__("Current","uipress-pro"),previous:__("Previous","uipress-pro"),users:__("users","uipress-pro")}}},inject:["uipData","uipress","uiTemplate"],watch:{"block.settings.block.options.chartDataType":{handler(e,t){this.currentRequest&&this.processResponse()}},"contextualData.groupDate":{handler(e,t){this.getAnalytics()},deep:!0},"uiTemplate.googleAnalytics.ready":{handler(e,t){this.getAnalytics()},deep:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(e,t){this.refreshAnalytics()}}},beforeDestroy:function(){this.map&&(this.map.remove(),this.map=!1)},mounted:function(){this.getAnalytics()},computed:{returnTableData(){return this.currentData},returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let e=this.uipress.get_block_option(this.block,"block","chartName",!0);return e?this.uipress.isObject(e)?"string"in e?e.string:void 0:e:""},returnChartType(){return this.uipress.get_block_option(this.block,"block","chartDataType")},inlineAccountSwitch(){let e=this.uipress.get_block_option(this.block,"block","inlineAccountSwitch");return this.uipress.isObject(e)&&"value"in e&&""!=e.value?e.value:e},darkMapTheme(){let e=this.uipress.get_block_option(this.block,"block","darkMode");return this.uipress.isObject(e)?"value"in e&&""!=e.value&&e.value:e},returnRange(){let e=this.uipress.get_block_option(this.block,"block","dateRange");return e?isNaN(e)?14:e>60?60:e:14},hasGlobalDate(){return void 0!==this.contextualData&&(!!this.uipress.isObject(this.contextualData)&&("groupDate"in this.contextualData&&("start"in this.contextualData.groupDate&&"end"in this.contextualData.groupDate)))}},methods:{getAnalytics(){let e,t,o=this;o.loading=!0,o.error=!1,o.errorMessage="",o.showGoogleConnection=!1,o.uipress.isObject(o.uiTemplate.googleAnalytics)&&"ready"in o.uiTemplate.googleAnalytics&&o.uiTemplate.googleAnalytics.ready?(o.apiLoaded=!0,this.hasGlobalDate?(e=new Date(Date.parse(this.contextualData.groupDate.start)),t=new Date(Date.parse(this.contextualData.groupDate.end))):((t=new Date).setDate(t.getDate()-1),(e=new Date).setDate(e.getDate()-o.returnRange)),o.startDate=e,o.endDate=t,o.uiTemplate.googleAnalytics.api("get",e,t).then(e=>{if(e.error)return o.loading=!1,o.error=!0,o.errorMessage=e.message,void("no_account"==e.type&&(o.showGoogleConnection=!0));o.loading=!1,o.currentRequest=e,o.processResponse(e)})):o.apiLoaded=!1},processResponse(){let e=this.currentRequest,t=this.returnChartType;t&&(this.currentData=e[t].report.data)},removeAnalyticsAccount(){let e=this;e.uiTemplate.googleAnalytics.ready=!1,e.uiTemplate.googleAnalytics.api("removeAccount").then(t=>{e.uiTemplate.googleAnalytics.api("refresh").then(t=>{e.uiTemplate.googleAnalytics.ready=!0,e.getAnalytics()})})},secondsToTime(e){if(isNaN(e))return 0;Math.floor(e/3600).toString().padStart(2,"0");const t=Math.floor(e%3600/60).toString().padStart(2,"0"),o=Math.floor(e%60).toString().padStart(2,"0");return 0==t?"0m "+o+"s":t+"m "+o+"s"},refreshAnalytics(){let e=this;e.uiTemplate.googleAnalytics.ready=!1,e.uiTemplate.googleAnalytics.api("refresh").then(t=>{t&&(e.uiTemplate.googleAnalytics.ready=!0,e.getAnalytics())})},returnFormattedDate(e){if(!e||""==e)return"";let t=e.getMonth()+1,o=e.getDate(),i=e.getFullYear();return t<10&&(t="0"+t),o<10&&(o="0"+o),i+"/"+t+"/"+o},returnMappCss:()=>uipProPath+"assets/css/libs/mapbox.css",returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(e){return this.errorMessage}if(this.uipress.isObject(JSON.parse(this.errorMessage))){let e=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${e.status}</h5>\n              <p style="margin-bottom:0;">${e.message}</p>\n            `}return this.errorMessage},buildMap(){let e=this;requestAnimationFrame(()=>{e.map&&(e.map.remove(),e.map=!1);let t=countries.returnCountries(),o="mapbox://styles/markashton/cldkdgzpx008t01rvfdmhtwet";(this.darkMapTheme||this.uipData.userPrefs.darkTheme)&&(o="mapbox://styles/markashton/cldklav6v009701rv47a1q7pa");let i=new mapboxgl.Map({container:"uip-ga-map",style:o,zoom:1,center:[-10,14]});e.map=i,i.addControl(new mapboxgl.NavigationControl);let a=t.ref_country_codes;for(const e of this.returnTableData){let t=a.find(t=>t.country.toLowerCase()===e.name.toLowerCase());if(void 0===t)continue;const o=document.createElement("div");o.className="marker uip-w-10 uip-ratio-1-1 uip-background-primary-wash uip-border-circle uip-border-primary";let n=3*e.percent_total;o.style.width=n+"px";let r="";e.change<0&&(r="arrow_downward"),e.change>0&&(r="arrow_upward");let s=`\n            <div class="uip-background-default uip-boder uip-shadow uip-border-rounder uip-overflow-hidden uip-text-normal">\n              <div class="uip-background-default">\n                <div class="uip-padding-xs uip-padding-top-xxs uip-padding-bottom-xxs uip-border-bottom uip-body-font uip-text-left uip-overflow-hidden uip-flex uip-flex-row uip-gap-xs uip-flex-between uip-flex-center">\n                \n                  <div class="uip-text-bold uip-text-emphasis">\n                    ${e.name}\n                  </div>\n                  \n                  <div class="uip-text-s uip-background-orange-wash uip-border-round uip-padding-xxxs uip-post-type-label uip-flex uip-gap-xxs uip-flex-center uip-text-bold uip-tag-label uip-text-muted">\n                    <span class="uip-icon">${r}</span>\n                    <span>${e.change}%</span>\n                  </div>\n                  \n                </div>\n                \n                <div class="uip-padding-xs uip-flex uip-flex-column uip-row-gap-xxs">\n                  <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-between uip-w-125">\n                    <div class="uip-text-bold uip-text-primary" >${e.value+" "+this.strings.users}</div>\n                    <div class="uip-text-s uip-text-muted">${this.strings.current}</div>\n                  </div>\n                  <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-between uip-w-125">\n                    <div class="uip-text-bold uip-text-orange">${e.value_comp+" "+this.strings.users}</div>\n                    <div class="uip-text-s uip-text-muted">${this.strings.previous}</div>\n                  </div>\n                </div>\n              </div>\n            </div>`;new mapboxgl.Marker(o).setLngLat([t.longitude,t.latitude]).setPopup(new mapboxgl.Popup({offset:25}).setHTML(s)).addTo(i)}})}},template:'\n\t\t<div class="uip-flex uip-flex-column">\n    \n      <component is="style">\n        @import \'{{returnMappCss()}}\';\n        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right{\n         display:none; \n        }\n        .marker {\n          border-radius: 50%;\n          cursor: pointer;\n          animation: pulse-outline 2.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) -.4s infinite;\n          transition: outline 5s ease, opacity .2s ease;\n        }\n        @keyframes pulse-outline {\n          0% {\n            outline: 0px solid var(--uip-color-primary-lighter);\n          }\n          100% {\n           outline: 12px solid transparent;\n          }\n        }\n        .mapboxgl-popup {\n          max-width: 200px;\n        }\n        .mapboxgl-popup-content {\n          padding:0;\n          box-shadow:none;\n          border-radius:4px;\n        }\n        .mapboxgl-popup-close-button {\n          top:5px; \n          display:none;\n        }\n        .uip-dark-mode .mapboxgl-ctrl-top-right{\n         filter: invert(1); \n        }\n        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip{\n          border-right-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip{\n          border-left-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-left .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-top-right .mapboxgl-popup-tip{\n          border-bottom-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-left .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        .mapboxgl-popup-anchor-bottom-right .mapboxgl-popup-tip{\n          border-top-color: var(--uip-color-base-0); \n        }\n        \n      </component>\n      \n      \n      <div class="uip-flex uip-flex-between">\n        <div class="uip-text-bold uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n        <drop-down dropPos="left" v-if="!inlineAccountSwitch && !showGoogleConnection">\n          <template v-slot:trigger>\n            <div class="uip-icon uip-link-muted">more_horiz</div>\n          </template>\n          <template v-slot:content>\n            <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-center uip-padding-xxxs uip-link-muted" @click="removeAnalyticsAccount()">\n              <div class="uip-icon">sync</div>              <div class="uip-padding-xxs">{{strings.changeAccount}}</div>\n            </div>\n          </template>\n        </drop-down>  \n      </div>\n      \n      <div class="uip-text-s uip-text-muted uip-margin-bottom-s uip-margin-bottom-s uip-dates">{{returnFormattedDate(startDate)}} - {{returnFormattedDate(endDate)}}</div>\n      \n      <div class="uip-margin-bottom-xxs" v-if="showGoogleConnection"><uip-connect-google :success="refreshAnalytics"></uip-connect-google></div>\n      \n      <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle uip-min-w-200 uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n      \n      <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n      \n      <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n      \n        \n      <div v-else class="uip-position-relative uip-h-100p" \n      :class="{\'uip-dark-mode\' : darkMapTheme || uipData.userPrefs.darkTheme}">\n        <div id=\'uip-ga-map\' class="uip-ga-map uip-w-300 uip-h-200"></div>\n        \n        {{buildMap()}}\n      </div>\n      \n     \n      \n\t\t </div>'}};